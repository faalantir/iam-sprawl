<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>IAM Policy Sprawl Dashboard</title>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f4f6f8;
      }
      h1 {
        text-align: center;
        margin-bottom: 25px;
      }

      /* Summary Cards */
      .summary-cards-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-bottom: 25px;
      }
      .summary-card {
        flex: 1 1 180px;
        background: linear-gradient(135deg, #6c5ce7, #00bfa6);
        padding: 20px;
        border-radius: 12px;
        color: #fff;
        text-align: center;
        font-weight: 600;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        transition: transform 0.2s;
      }
      .summary-card:hover {
        transform: translateY(-5px);
      }
      .summary-card .value {
        display: block;
        font-size: 1.8em;
        margin-top: 5px;
      }

      /* ECharts containers */
      #reviewChart,
      #entityChart {
        max-width: 600px;
        height: 300px;
        margin: 0 auto 40px auto;
      }

      /* Modern Table */
      table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        background-color: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        margin-bottom: 40px;
      }
      th {
        background: linear-gradient(135deg, #6c5ce7, #00bfa6);
        color: #fff;
        padding: 12px;
        font-weight: 600;
        text-align: left;
      }
      td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
      }
      tr:nth-child(even) {
        background-color: #f7f9fc;
      }
      tr:hover {
        background-color: #e1f0ff;
      }

      /* Issue badges */
      .issue-badge {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.85em;
        font-weight: 600;
        color: #fff;
        display: inline-block;
      }
      .issue-critical {
        background: #ef4444;
      }
      .issue-broad {
        background: #fbbf24;
      }
      .issue-fine {
        background: #10b981;
      }

      /* Buttons & Badge */
      .btn {
        padding: 6px 10px;
        cursor: pointer;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.9em;
      }
      .btn.reviewed {
        background-color: #10b981;
        cursor: default;
      }
      .badge {
        padding: 3px 7px;
        background-color: #10b981;
        color: white;
        border-radius: 4px;
        font-size: 0.85em;
      }
      .opacity-60 {
        opacity: 0.6;
      }

      /* Floating Upload Button */
      #upload-form label.btn {
        padding: 10px 14px;
        background-color: #2563eb;
        cursor: pointer;
        font-weight: 600;
      }

      /* Responsive */
      @media (max-width: 600px) {
        .summary-cards-container {
          flex-direction: column;
          align-items: center;
        }
        #reviewChart,
        #entityChart {
          width: 100%;
        }
        table {
          font-size: 0.9em;
        }
      }
    </style>
  </head>
  <body>
    <h1>IAM Policy Sprawl Dashboard</h1>

    <!-- Summary Cards -->
    <div class="summary-cards-container">
      <div class="summary-card">
        Total Issues
        <span class="value" id="total-issues">{{ total_issues }}</span>
      </div>
      <div class="summary-card">
        Reviewed
        <span class="value" id="total-reviewed">{{ total_reviewed }}</span>
      </div>
      <div class="summary-card">
        Yet to Review
        <span class="value" id="total-yet"
          >{{ total_issues - total_reviewed }}</span
        >
      </div>
    </div>

    <!-- Charts -->
    <div id="reviewChart"></div>
    <div id="entityChart"></div>

    <!-- Floating Upload Button -->
    <form
      id="upload-form"
      style="position: fixed; bottom: 20px; right: 20px; z-index: 1000"
    >
      <label for="report-file" class="btn">Upload New Report</label>
      <input
        type="file"
        id="report-file"
        name="report"
        accept=".json"
        style="display: none"
      />
    </form>

    <!-- Issues Table -->
    <table>
      <thead>
        <tr>
          <th>Entity</th>
          <th>Type</th>
          <th>Policy</th>
          <th>Issue</th>
          <th>Resource</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for f in findings %}
        <tr id="row-{{ f.id }}">
          <td>{{ f.entity_name }}</td>
          <td>{{ f.entity_type }}</td>
          <td>{{ f.policy_name }}</td>
          <td>
            <span
              class="issue-badge {% if f.issue_type in ['wildcard_action','wildcard_resource'] %}issue-critical {% elif f.issue_type == 'broad_service' %}issue-broad {% else %}issue-fine{% endif %}"
            >
              {{ f.issue_type }}
            </span>
          </td>
          <td>{{ f.resource }}</td>
          <td id="btnwrap-{{ f.id }}">
            {% if f.is_reviewed %}
            <span class="badge">Reviewed ✓</span>
            {% else %}
            <button
              class="btn review-btn"
              data-id="{{ f.id }}"
              data-entity_type="{{ f.entity_type }}"
              data-entity_name="{{ f.entity_name }}"
              data-policy_name="{{ f.policy_name }}"
              data-issue_type="{{ f.issue_type }}"
              data-resource="{{ f.resource }}"
            >
              Mark as reviewed
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <script>
      // ECharts - Reviewed vs Yet to Review
      const reviewChart = echarts.init(document.getElementById('reviewChart'));
      reviewChart.setOption({
        title: { text: 'Reviewed vs Yet to Review', left: 'center' },
        tooltip: { trigger: 'item' },
        legend: { bottom: 10 },
        series: [{
          name: 'Status',
          type: 'pie',
          radius: ['40%', '70%'],
          avoidLabelOverlap: false,
          itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
          label: { show: true, position: 'outside', formatter: '{b}: {c}' },
          emphasis: { label: { show: true, fontSize: '16', fontWeight: 'bold' } },
          data: [
            { value: {{ total_reviewed }}, name: 'Reviewed' },
            { value: {{ total_issues - total_reviewed }}, name: 'Yet to Review' }
          ]
        }]
      });

      // ECharts - Entity Type Breakdown
      const entityChart = echarts.init(document.getElementById('entityChart'));
      entityChart.setOption({
        title: { text: 'Entities by Type', left: 'center' },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        xAxis: { type: 'category', data: {{ summary_labels | tojson | safe }} },
        yAxis: { type: 'value' },
        series: [{
          data: {{ summary_values | tojson | safe }},
          type: 'bar',
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
              { offset: 0, color: '#6c5ce7' },
              { offset: 1, color: '#00bfa6' }
            ])
          },
          barWidth: '40%',
          label: { show: true, position: 'top', color: '#333' },
          animationDuration: 1000
        }]
      });

      // Mark as Reviewed
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".review-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            btn.disabled = true;
            btn.innerText = "Saving...";
            const payload = {
              id: btn.dataset.id,
              entity_type: btn.dataset.entity_type,
              entity_name: btn.dataset.entity_name,
              policy_name: btn.dataset.policy_name,
              issue_type: btn.dataset.issue_type,
              resource: btn.dataset.resource
            };
            try {
              const res = await fetch("/review", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              const totalIssuesEl = document.getElementById("total-issues");
              const totalReviewedEl = document.getElementById("total-reviewed");
              const totalYetEl = document.getElementById("total-yet");
              if (res.ok) {
                btn.innerText = "Reviewed ✓";
                btn.classList.add("reviewed");
                const row = document.getElementById("row-" + payload.id);
                if (row) row.classList.add("opacity-60");
                const btnWrap = document.getElementById("btnwrap-" + payload.id);
                if (btnWrap) btnWrap.innerHTML = '<span class="badge">Reviewed ✓</span>';

                let totalReviewed = parseInt(totalReviewedEl.textContent.trim()) || 0;
                totalReviewed += 1;
                totalReviewedEl.innerText = totalReviewed;
                totalYetEl.innerText = Math.max(parseInt(totalIssuesEl.textContent.trim()) - totalReviewed, 0);

                reviewChart.setOption({
                  series: [{ data: [
                    { value: totalReviewed, name: 'Reviewed' },
                    { value: parseInt(totalIssuesEl.textContent.trim()) - totalReviewed, name: 'Yet to Review' }
                  ]}]
                });
              } else { btn.innerText = "Error"; }
            } catch (e) { console.error(e); btn.innerText = "Error"; }
            btn.disabled = false;
          });
        });
      });

      // Upload New Report
      document.getElementById("report-file").addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("report", file);
        try {
          const res = await fetch("/upload-report", { method: "POST", body: formData });
          if (res.ok) { alert("Report uploaded successfully!"); location.reload(); }
          else { alert("Failed to upload report."); }
        } catch (e) { console.error(e); alert("Error uploading file."); }
      });
    </script>
  </body>
</html>
